// Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ° Ğ¸Ğ· /data
const state = { stories: [], friends: [], filter: '' };
const el = (sel) => document.querySelector(sel);

async function loadJSON(path){ const res = await fetch(path, {cache:'no-store'}); if(!res.ok) throw new Error('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ '+path); return res.json(); }
function formatDate(iso){ try{ const d=new Date(iso); return d.toLocaleDateString('ru-RU',{year:'numeric',month:'long',day:'numeric'});}catch(e){ return iso;}}
function storyCard(s){ const tags=(s.tags||[]).map(t=>`<span class="tag">#${t}</span>`).join(' '); const images=(s.images||[]).map(name=>`<img src="assets/${typeof name==='string'?name:(name && name.image)||''}" alt="">`).join(''); return `<article class="card"><div class="meta"><span>ğŸ“… ${formatDate(s.date)}</span><span>â€¢</span><span>ğŸ•® ${s.mood||'â€”'}</span>${s.author?`<span>â€¢</span><span>ğŸ‘¤ ${s.author}</span>`:''}</div><h4>${s.title}</h4><p>${s.text}</p><div>${tags}</div><div class="images">${images}</div></article>`; }
function friendCard(f){ const avatar=f.avatar?`<img class="avatar" src="assets/${f.avatar}" alt="">`:''; const socials=f.link?`<div><a href="${f.link}" target="_blank" rel="noreferrer">ÑÑÑ‹Ğ»ĞºĞ°</a></div>`:''; return `<div class="friend">${avatar}<div class="name">ğŸ‘¤ ${f.name}${f.nickname?' â€” '+f.nickname:''}</div><div class="quote">â€œ${f.quote||''}â€</div><div class="bio">${f.memory||''}</div>${socials}</div>`; }
function render(){ const q=state.filter.toLowerCase().trim(); const filtered=state.stories.filter(s=>{ const hay=[s.title,s.text,...(s.tags||[])].join(' ').toLowerCase(); return hay.includes(q);}); el('#timelineList').innerHTML = filtered.map(storyCard).join(''); el('#noResults').style.display = filtered.length?'none':'block'; el('#friendsGrid').innerHTML = state.friends.map(friendCard).join(''); const imgs=state.stories.flatMap(s=>s.images||[]).map(x=>typeof x==='string'?x:(x && x.image)||''); const uniq=[...new Set(imgs)]; el('#galleryGrid').innerHTML = uniq.map(name=>`<img src="assets/${name}" alt="">`).join(''); }
function bind(){ el('#search').addEventListener('input',(e)=>{ state.filter=e.target.value; render();}); el('#addEntryBtn').addEventListener('click',()=>{ alert('Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ² /admin (Ğ´Ğ»Ñ Ñ‚ĞµĞ±Ñ) Ğ¸Ğ»Ğ¸ /friends (Ğ´Ğ»Ñ Ğ´Ñ€ÑƒĞ·ĞµĞ¹).');}); }
async function init(){ try{ const [stories, friends, submissions] = await Promise.all([ loadJSON('data/stories.json'), loadJSON('data/friends.json'), loadJSON('data/submissions.json') ]); const approvedSubs = (submissions.submissions||[]).filter(x=>x.approved); state.stories = [...(stories.stories||[]), ...approvedSubs]; state.friends = friends.friends || []; render(); bind(); }catch(err){ console.error(err); el('#timelineList').innerHTML='<p class="muted">ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² Ğ¿Ğ°Ğ¿ĞºĞµ data/</p>'; } } init();
